<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso de Administrador</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos básicos para el login */
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #1a2a6c, #3a0ca3, #4361ee); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            margin: 0;
        }
        .login-card { 
            background: white; 
            padding: 40px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            text-align: center; 
            width: 90%; 
            max-width: 400px; 
        }
        .login-card h1 { 
            color: #3a0ca3; 
            margin-bottom: 25px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 15px; 
            font-size: 2em;
        }
        .login-card h1 i { 
            background: #3a0ca3; 
            color: white; 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.2em;
        }
        .form-group { 
            margin-bottom: 20px; 
            position: relative; 
        }
        .form-group input { 
            width: 100%; 
            padding: 15px 15px 15px 50px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            font-size: 16px; 
            box-sizing: border-box; 
        }
        .form-group i { 
            position: absolute; 
            left: 18px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: #6c757d; 
            font-size: 18px; 
        }
        button { 
            background-color: #4361ee; 
            color: white; 
            border: none; 
            padding: 15px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 500; 
            width: 100%; 
            transition: background-color 0.3s; 
            display: flex; /* Para centrar icono y texto */
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:hover { 
            background-color: #3a0ca3; 
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        button .spinner { display: none; }
        button.loading .spinner { display: inline-block; }
        button.loading .button-text { opacity: 0.7; }

        #message { 
            margin-top: 20px; 
            color: #dc3545; 
            font-weight: 500; 
            min-height: 1.2em; /* Espacio para el mensaje */
        }
    </style>
</head>
<body>
    <div class="login-card">
        <h1><i class="fas fa-crown"></i> Panel Admin</h1>
        <div class="form-group">
            <i class="fas fa-lock"></i>
            <input type="password" id="password" placeholder="Contraseña de Administrador" onkeydown="handleEnter(event)">
        </div>
        <button id="loginButton" onclick="login()">
            <span class="button-text">Entrar</span>
            <i class="fas fa-spinner fa-spin spinner"></i>
        </button>
        <p id="message"></p>
    </div>

    <script>
        // --- ¡¡IMPORTANTE!! REEMPLAZA ESTOS VALORES ---
        const SUPABASE_URL = "https://iqigjulbvmkokorecjie.supabase.co"; // TU URL
        // Esta es la llave pública ANÓNIMA (anon key), es seguro tenerla aquí
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlxaWdqdWxidm1rb2tvcmVjamllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NDIwMzYsImV4cCI6MjA2OTAxODAzNn0.7b2QoP-CAlT91z-y1GvGgDASN820m-e-z1o-nBf7eTc"; // TU LLAVE ANÓNIMA
        // --- FIN DE VALORES A REEMPLAZAR ---

        const passwordInput = document.getElementById('password');
        const messageEl = document.getElementById('message');
        const loginButton = document.getElementById('loginButton');

        // Redirigir si ya hay un token
        if (localStorage.getItem('supabase_admin_token')) {
            window.location.href = 'admin.html';
        }

        function showButtonSpinner() {
            loginButton.disabled = true;
            loginButton.classList.add('loading');
        }

        function hideButtonSpinner() {
            loginButton.disabled = false;
            loginButton.classList.remove('loading');
        }

        async function login() {
            const password = passwordInput.value;
            messageEl.textContent = ''; // Limpiar mensaje previo

            if (!password) {
                messageEl.textContent = "Ingresa la contraseña.";
                return;
            }

            showButtonSpinner();

            try {
                // Llamar a la función SQL 'check_password'
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/check_password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_KEY, // Usar llave anónima para esta llamada
                        'Authorization': `Bearer ${SUPABASE_KEY}` // Usar llave anónima
                    },
                    body: JSON.stringify({ input_password: password }) // El parámetro se llama input_password
                });

                if (!response.ok) {
                    // Manejar errores de red o del servidor Supabase
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success === true && result.token) {
                    // ¡Éxito! Guardamos el token (que tiene permisos de service_role)
                    localStorage.setItem('supabase_admin_token', result.token);
                    // Redirigimos al panel de administración
                    window.location.href = 'admin.html';
                } else {
                    messageEl.textContent = result.message || "Contraseña incorrecta.";
                    hideButtonSpinner();
                }
            } catch (error) {
                console.error("Error al intentar loguear:", error);
                messageEl.textContent = "Error de conexión o configuración. Revisa la consola (F12).";
                hideButtonSpinner();
            }
        }

        // Permitir login con Enter
        function handleEnter(event) {
            if (event.key === 'Enter') {
                login();
            }
        }
    </script>
</body>
</html>