<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Rifa Exclusive</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8f9fe;
            --surface-color: #ffffff;
            --primary-color: #2c3e50; /* Azul Nocturno */
            --secondary-color: #34495e; /* Azul Grisáceo */
            --accent-color: #d4af37; /* Oro Viejo */
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #e5e7eb;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --shadow-color: rgba(44, 62, 80, 0.1);
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 40px var(--shadow-color);
            padding: 30px;
            border: 1px solid var(--border-color);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        h1 {
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        h1 i {
            color: var(--accent-color);
        }
        
        .panel-section {
            background-color: var(--bg-color);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }
        
        .panel-section h2 {
            margin-top: 0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            transition: var(--transition);
            background-color: var(--surface-color);
            color: var(--text-primary);
        }
        
        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 20%, transparent);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px var(--shadow-color);
        }
        .stat-card i {
            font-size: 2rem;
            padding: 15px;
            border-radius: 50%;
            background-color: var(--bg-color);
        }
        .stat-card .icon-sales { color: var(--success-color); }
        .stat-card .icon-pending { color: var(--warning-color); }
        .stat-card .icon-verified { color: var(--primary-color); }
        .stat-card .icon-sold { color: #8e44ad; }
        .stat-card .icon-available { color: #2980b9; }

        .stat-info .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .stat-info .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
        }
        
        .search-container {
            flex: 1 1 300px;
            position: relative;
        }
        .search-container input {
            padding-left: 45px;
        }
        .search-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        
        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        thead {
            background-color: var(--bg-color);
        }
        
        th {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        tbody tr:hover {
            background-color: color-mix(in srgb, var(--accent-color) 5%, transparent);
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        .status-verified {
            background-color: color-mix(in srgb, var(--success-color) 15%, transparent);
            color: var(--success-color);
        }
        .status-pending {
            background-color: color-mix(in srgb, var(--warning-color) 15%, transparent);
            color: var(--warning-color);
        }
        
        .duplicate-cell {
            background-color: color-mix(in srgb, var(--danger-color) 15%, transparent);
            border: 1px solid var(--danger-color);
            border-radius: 4px;
            padding: 2px 5px;
            font-weight: bold;
        }

        button, .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        button:hover, .btn:hover {
            filter: brightness(1.2);
            transform: translateY(-2px);
        }
        
        .btn-refresh { background-color: var(--secondary-color); }
        .btn-verify { background-color: var(--success-color); }
        .btn-delete { background-color: var(--danger-color); }
        .btn-view { background-color: #2980b9; }
        .btn-disabled { background-color: var(--text-secondary); cursor: not-allowed; }
        .btn-whatsapp { background-color: #25D366; }
        
        .filter-btn {
            background-color: var(--surface-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .filter-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal.open {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: var(--surface-color);
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 700px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            transition: var(--transition);
            transform: scale(0.95);
        }
        .modal.open .modal-content {
            transform: scale(1);
        }
        
        .modal h2 {
            margin-bottom: 20px;
        }
        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: flex-end;
        }
        .modal-buttons button { flex: none; }
        
        .ticket-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
        }
        
        .ticket-number {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 12px;
            font-weight: 600;
            font-family: monospace;
            text-align: center;
            color: var(--primary-color);
        }

        .whatsapp-link {
            color: #25D366;
            font-weight: bold;
            text-decoration: none;
        }
        .whatsapp-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-crown"></i> Panel de Administración</h1>
            <button class="btn-refresh" onclick="loadTransactions(true)">
                <i class="fas fa-sync-alt"></i> Refrescar
            </button>
        </div>
        
        <div class="panel-section">
            <h2><i class="fas fa-cogs"></i> Configuración de la Rifa</h2>
            <div class="config-grid">
                <div class="input-group">
                    <label>Total de Boletos</label>
                    <input type="number" id="totalTickets" value="10000">
                </div>
                <div class="input-group">
                    <label>Precio por Boleto (Bs.)</label>
                    <input type="number" id="ticketPrice" value="80">
                </div>
                <div class="input-group">
                    <label>Fecha del Sorteo</label>
                    <input type="text" id="raffleDate" placeholder="Ej: 30 de Diciembre">
                </div>
                <div class="input-group">
                    <label>URL Imagen Premio</label>
                    <input type="text" id="prizeImageUrl" value="https://i.ibb.co/RTbcLX0p/combo-ogra-2-0.jpg">
                </div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <i class="fas fa-hand-holding-dollar icon-sales"></i>
                <div class="stat-info">
                    <div class="stat-value" id="totalSales">Bs. 0</div>
                    <div class="stat-label">INGRESOS (VERIFICADOS)</div>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-hourglass-half icon-pending"></i>
                <div class="stat-info">
                    <div class="stat-value" id="pendingCount">0</div>
                    <div class="stat-label">TRANSACCIONES PENDIENTES</div>
                </div>
            </div>
            <div class="stat-card">
                 <i class="fas fa-check-circle icon-verified"></i>
                <div class="stat-info">
                    <div class="stat-value" id="verifiedCount">0</div>
                    <div class="stat-label">TRANSACCIONES VERIFICADAS</div>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-ticket icon-sold"></i>
                <div class="stat-info">
                    <div class="stat-value" id="soldTickets">0</div>
                    <div class="stat-label">BOLETOS VENDIDOS</div>
                </div>
            </div>
            <div class="stat-card">
                 <i class="fas fa-layer-group icon-available"></i>
                <div class="stat-info">
                    <div class="stat-value" id="availableTickets">0</div>
                    <div class="stat-label">BOLETOS DISPONIBLES</div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Buscar por nombre, cédula, referencia o teléfono..." onkeyup="handleSearch()">
            </div>
            <div class="filters">
                <button class="filter-btn active" data-filter="all">Todos</button>
                <button class="filter-btn" data-filter="pending">Pendientes</button>
                <button class="filter-btn" data-filter="verified">Verificados</button>
            </div>
        </div>
        
        <div class="table-container">
            <table id="transactionsTable">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Nombre</th>
                        <th>CI</th>
                        <th>Teléfono</th>
                        <th>Boletos</th>
                        <th>Referencia</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="ticketsModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle"></h2>
            <p id="modalDescription"></p>
            <div id="modalTicketList" class="ticket-list"></div>
            <div class="modal-buttons">
                <button id="modalCloseBtn" class="btn btn-secondary">Cerrar</button>
                <button id="modalCopyBtn" class="btn">
                    <i class="fas fa-copy"></i> Copiar Números
                </button>
                <button id="modalWhatsappBtn" class="btn btn-whatsapp">
                    <i class="fab fa-whatsapp"></i> Enviar por WhatsApp
                </button>
            </div>
        </div>
    </div>


    <script>
        const CONFIG = {
            supabaseUrl: "https://iqigjulbvmkokorecjie.supabase.co",
            supabaseKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlxaWdqdWxidm1rb2tvcmVjamllIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MzQ0MjAzNiwiZXhwIjoyMDY5MDE4MDM2fQ.F_ewIibBG7QgpSYfnUKzosl46prz7Kv_BD8-Xnrxj-c"
        };
        
        let allTransactions = [];
        let currentFilter = 'all';
        let currentSearch = '';
        let duplicateReferences = new Set();
        let duplicatePhones = new Set();
        let duplicateIds = new Set();

        // --- CORE FUNCTIONS ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadTransactions(true);
        });

        function setupEventListeners() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelector('.filter-btn.active').classList.remove('active');
                    e.target.classList.add('active');
                    currentFilter = e.target.dataset.filter;
                    renderTransactions();
                });
            });

            const modal = document.getElementById('ticketsModal');
            document.getElementById('modalCloseBtn').addEventListener('click', () => modal.classList.remove('open'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('open');
            });
        }
        
        let searchTimeout;
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearch = document.getElementById('searchInput').value.toLowerCase();
                renderTransactions();
            }, 300);
        }

        async function loadTransactions(forceRefresh = false) {
            if (allTransactions.length > 0 && !forceRefresh) {
                renderTransactions();
                return;
            }
            
            const tbody = document.querySelector("#transactionsTable tbody");
            tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;"><i class="fas fa-spinner fa-spin"></i> Cargando...</td></tr>`;

            try {
                const response = await fetch(`${CONFIG.supabaseUrl}/rest/v1/transactions?select=*&order=created_at.desc`, {
                    headers: { 'apikey': CONFIG.supabaseKey, 'Authorization': `Bearer ${CONFIG.supabaseKey}` }
                });
                if (!response.ok) throw new Error('Network response was not ok');
                
                allTransactions = await response.json();
                findDuplicates();
                renderTransactions();
                updateStats();
            } catch (error) {
                console.error("Error loading transactions:", error);
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; color: var(--danger-color);"><i class="fas fa-exclamation-triangle"></i> Error al cargar datos.</td></tr>`;
            }
        }

        // --- DATA PROCESSING & RENDERING ---
        
        function findDuplicates() {
            const references = new Map();
            const phones = new Map();
            const ids = new Map();
            
            allTransactions.forEach(t => {
                if (t.reference) references.set(t.reference, (references.get(t.reference) || 0) + 1);
                if (t.phone) phones.set(t.phone.replace(/\D/g, ''), (phones.get(t.phone.replace(/\D/g, '')) || 0) + 1);
                if (t.id_number) ids.set(t.id_number, (ids.get(t.id_number) || 0) + 1);
            });

            duplicateReferences = new Set([...references].filter(([k, v]) => v > 1).map(([k, v]) => k));
            duplicatePhones = new Set([...phones].filter(([k, v]) => v > 1).map(([k, v]) => k));
            duplicateIds = new Set([...ids].filter(([k, v]) => v > 1).map(([k, v]) => k));
        }

        function updateStats() {
            const totalTickets = parseInt(document.getElementById('totalTickets').value);
            const ticketPrice = parseFloat(document.getElementById('ticketPrice').value);
            
            const verified = allTransactions.filter(t => t.status === 'VERIFICADO');
            const pending = allTransactions.filter(t => t.status === 'PENDIENTE');

            const totalSales = verified.reduce((sum, t) => sum + (t.tickets * ticketPrice), 0);
            const soldTickets = verified.reduce((sum, t) => sum + t.tickets, 0);

            document.getElementById('totalSales').textContent = `Bs. ${totalSales.toLocaleString('es-VE')}`;
            document.getElementById('pendingCount').textContent = pending.length;
            document.getElementById('verifiedCount').textContent = verified.length;
            document.getElementById('soldTickets').textContent = soldTickets.toLocaleString('es-VE');
            document.getElementById('availableTickets').textContent = (totalTickets - soldTickets).toLocaleString('es-VE');
        }

        function renderTransactions() {
            const tbody = document.querySelector("#transactionsTable tbody");
            tbody.innerHTML = "";

            const filtered = allTransactions.filter(t => {
                const matchesFilter = currentFilter === 'all' || t.status.toLowerCase() === currentFilter;
                const matchesSearch = !currentSearch ||
                    t.name.toLowerCase().includes(currentSearch) ||
                    t.id_number.toLowerCase().includes(currentSearch) ||
                    t.reference.toLowerCase().includes(currentSearch) ||
                    t.phone.includes(currentSearch);
                return matchesFilter && matchesSearch;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;"><i class="fas fa-info-circle"></i> No se encontraron transacciones.</td></tr>`;
                return;
            }

            filtered.forEach(t => {
                const row = document.createElement("tr");
                const isDuplicateRef = duplicateReferences.has(t.reference);
                const isDuplicatePhone = duplicatePhones.has(t.phone.replace(/\D/g, ''));
                const isDuplicateId = duplicateIds.has(t.id_number);
                
                row.innerHTML = `
                    <td>${new Date(t.created_at).toLocaleString('es-VE')}</td>
                    <td><b>${t.name}</b></td>
                    <td class="${isDuplicateId ? 'duplicate-cell' : ''}">${t.id_number}</td>
                    <td class="${isDuplicatePhone ? 'duplicate-cell' : ''}">
                        <a href="https://wa.me/${t.phone.replace(/\D/g, '')}" target="_blank" class="whatsapp-link">${t.phone}</a>
                    </td>
                    <td>${t.tickets}</td>
                    <td class="${isDuplicateRef ? 'duplicate-cell' : ''}">${t.reference}</td>
                    <td><span class="status-badge status-${t.status.toLowerCase()}">${t.status}</span></td>
                    <td>
                        <div style="display:flex; gap: 8px;">
                        ${t.status !== "VERIFICADO" ? 
                            `<button class="btn btn-verify" onclick="verifyTransaction(${t.id}, ${t.tickets})"><i class="fas fa-check"></i> Verificar</button>` : 
                            `<button class="btn btn-view" onclick="viewTickets(${t.id}, '${t.name}')"><i class="fas fa-eye"></i> Ver Boletos</button>`}
                        <button class="btn btn-delete" onclick="deleteTransaction(${t.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // --- ACTIONS (VERIFY, DELETE, VIEW) ---

        async function verifyTransaction(transactionId, quantity) {
            if (!confirm(`¿Confirmas el pago y deseas generar ${quantity} boletos?`)) return;

            try {
                // 1. Get all existing ticket numbers
                const existingTicketsResponse = await fetch(`${CONFIG.supabaseUrl}/rest/v1/tickets?select=ticket_number`, {
                    headers: { 'apikey': CONFIG.supabaseKey, 'Authorization': `Bearer ${CONFIG.supabaseKey}` }
                });
                const existingTicketsData = await existingTicketsResponse.json();
                const existingTicketNumbers = new Set(existingTicketsData.map(t => t.ticket_number));

                // 2. Generate new, unique ticket numbers
                const totalTickets = parseInt(document.getElementById('totalTickets').value);
                const newTickets = [];
                while (newTickets.length < quantity) {
                    const ticketNumber = Math.floor(Math.random() * totalTickets) + 1;
                    if (!existingTicketNumbers.has(ticketNumber)) {
                        newTickets.push({ transaction_id: transactionId, ticket_number: ticketNumber, status: "ACTIVO" });
                        existingTicketNumbers.add(ticketNumber);
                    }
                }
                
                // 3. Insert new tickets
                const insertResponse = await fetch(`${CONFIG.supabaseUrl}/rest/v1/tickets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'apikey': CONFIG.supabaseKey, 'Authorization': `Bearer ${CONFIG.supabaseKey}` },
                    body: JSON.stringify(newTickets)
                });
                if (!insertResponse.ok) throw new Error('Failed to insert tickets');

                // 4. Update transaction status
                const updateResponse = await fetch(`${CONFIG.supabaseUrl}/rest/v1/transactions?id=eq.${transactionId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'apikey': CONFIG.supabaseKey, 'Authorization': `Bearer ${CONFIG.supabaseKey}` },
                    body: JSON.stringify({ status: 'VERIFICADO' })
                });
                if (!updateResponse.ok) throw new Error('Failed to update transaction');
                
                alert('Transacción verificada y boletos generados!');
                const transaction = allTransactions.find(t => t.id === transactionId);
                showTicketsModal(transaction, newTickets.map(t => t.ticket_number));
                loadTransactions(true);
            } catch (error) {
                console.error("Error verifying transaction:", error);
                alert("Error al verificar la transacción.");
            }
        }

        async function deleteTransaction(transactionId) {
            if (!confirm("¿Seguro que quieres eliminar esta transacción? Se borrarán también los boletos asociados. Esta acción es irreversible.")) return;

            try {
                await fetch(`${CONFIG.supabaseUrl}/rest/v1/tickets?transaction_id=eq.${transactionId}`, {
                    method: 'DELETE',
                    headers: { 'apikey': CONFIG.supabaseKey, 'Authorization': `Bearer ${CONFIG.supabaseKey}` }
                });

                await fetch(`${CONFIG.supabaseUrl}/rest/v1/transactions?id=eq.${transactionId}`, {
                    method: 'DELETE',
                    headers: { 'apikey': CONFIG.supabaseKey, 'Authorization': `Bearer ${CONFIG.supabaseKey}` }
                });
                
                alert('Transacción eliminada.');
                loadTransactions(true);
            } catch (error) {
                console.error("Error deleting transaction:", error);
                alert("Error al eliminar la transacción.");
            }
        }
        
        async function viewTickets(transactionId, name) {
            try {
                const response = await fetch(`${CONFIG.supabaseUrl}/rest/v1/tickets?transaction_id=eq.${transactionId}&select=ticket_number`, {
                    headers: { 'apikey': CONFIG.supabaseKey, 'Authorization': `Bearer ${CONFIG.supabaseKey}` }
                });
                const ticketData = await response.json();
                const transaction = allTransactions.find(t => t.id === transactionId);
                showTicketsModal(transaction, ticketData.map(t => t.ticket_number));
            } catch (error) {
                console.error("Error fetching tickets:", error);
                alert("Error al cargar los boletos.");
            }
        }

        // --- MODAL & HELPERS ---
        
        function showTicketsModal(transaction, ticketNumbers) {
            const modal = document.getElementById('ticketsModal');
            document.getElementById('modalTitle').textContent = `Boletos de ${transaction.name}`;
            document.getElementById('modalDescription').textContent = `Se han asignado ${ticketNumbers.length} boletos.`;
            document.getElementById('modalTicketList').innerHTML = ticketNumbers
                .map(num => `<div class="ticket-number">${String(num).padStart(5, '0')}</div>`)
                .join('');

            const formattedTickets = ticketNumbers.map(n => String(n).padStart(5, '0')).join(', ');

            document.getElementById('modalCopyBtn').onclick = () => {
                navigator.clipboard.writeText(formattedTickets).then(() => alert('Números copiados!'));
            };

            document.getElementById('modalWhatsappBtn').onclick = () => {
                 const message = encodeURIComponent(
                    `*¡Felicidades! Tus boletos para la Rifa Exclusive están listos* 🥳\n\n` +
                    `Hola ${transaction.name}, gracias por tu compra. Aquí tienes tus números de la suerte:\n\n` +
                    `*${formattedTickets}*\n\n` +
                    `¡Te deseamos mucha suerte en el sorteo! 🍀\n\n` +
                    `_Equipo Gana con Yair™_`
                );
                window.open(`https://wa.me/${transaction.phone.replace(/\D/g, '')}?text=${message}`, '_blank');
            };

            modal.classList.add('open');
        }
    </script>
</body>
</html>